metadata:
  scope: "glaedr"

settings:
  kubeContext: $K8SCLUSTER
  storageBackend: "secret"
  slackWebhook: $SLACK_HOOK
  globalMaxHistory: 500
  reverseDelete: true

namespaces:
  clustering:
    protected: false
  linkerd:
    protected: false
    annotations:
      linkerd.io/inject: disabled
    labels:
      linkerd.io/is-control-plane: "true"
      config.linkerd.io/admission-webhooks: disabled
      linkerd.io/control-plane-ns: "linkerd"
  linkerd-viz:
    protected: false
    labels:
      linkerd.io/extension: viz
    annotations:
      linkerd.io/inject: enabled
      viz.linkerd.io/external-prometheus: $K8S_PROMETHEUS

appsTemplates:

  in_use: &enabled
    enabled: true
    test: false
    wait: true
    timeout: 120
    helmFlags:
      - "--atomic"

  no_use: &disabled
    enabled: false

  linkerd: &mesh1
    enabled: true
    test: false
    wait: true
    timeout: 120
    hooks:
      preInstall: "bash -x linkerd_step.sh main"
      preUpgrade: "bash -x linkerd_step.sh main"
      postInstall: "linkerd check"
    setFile:
      identityTrustAnchorsPEM: linkerd/certs/plane/ca.crt
      proxyInjector.caBundle: linkerd/certs/plane/ca.crt
      profileValidator.caBundle: linkerd/certs/plane/ca.crt
    set:
      identity.issuer.scheme: "kubernetes.io/tls"
      identity.externalIssuer: true
      proxyInjector.externalSecret: true
      profileValidator.externalSecret: true
      identity.issuer.crtExpiry: $EXP
      installNamespace: "false"
    helmFlags:
      - "--atomic"

  linkerd_viz: &mesh2
    enabled: true
    test: false
    wait: false
    timeout: 120
    hooks:
      deleteOnSuccess: true
      preInstall: "bash -x linkerd_step.sh secrets_linkerd_viz"
      preUpgrade: "bash -x linkerd_step.sh secrets_linkerd_viz"
      successCondition: "Complete"
      postInstall: "linkerd check"
    setFile:
      tap.caBundle: linkerd/certs/plane/ca.crt
      tapInjector.caBundle: linkerd/certs/plane/ca.crt
    set:
      installNamespace: false
      tap.externalSecret: true
      tapInjector.externalSecret: true
      tap.replicas: 3
      grafana.enabled: true
      # grafanaUrl: $K8S_GRAFANA
      prometheus.enabled: true
      # prometheusUrl: $K8S_PROMETHEUS
      dashboard.enforcedHostRegexp: ".*"
    valuesFiles:
      - "linkerd-viz-certificates/templates/webhook-certificate.yaml"
      - "linkerd-viz-certificates/templates/tap-injector-certificate.yaml"
    helmFlags:
      - "--atomic"

apps:

  # Monitoring & SRE Block (priority: -140)

    prometheus:
      <<: *enabled
      description: "Prometheus clusters atop Kubernetes"
      group: "monitoring"
      namespace: "monitoring"
      chart: "kube-prometheus-stack"
      version: "34.10.0"
      priority: -139
      set:
        alertmanager.ingress.enabled: true
        alertmanager.ingress.ingressClassName: $K8S_INGRESS
        alertmanager.ingress.hosts: "{alertmanager.$K8SCLUSTER.$K8S_CLUSTER}"
        grafana.enabled: false
        grafana.ingress.enabled: true
        grafana.ingress.hosts: "{grafana.$K8SCLUSTER.$K8S_CLUSTER}"
        prometheus.ingress.enabled: true
        prometheus.ingress.ingressClassName: $K8S_INGRESS
        prometheus.ingress.hosts: "{prometheus.$K8SCLUSTER.$K8S_CLUSTER}"
        kubeControllerManager.enabled: false
        kubeScheduler.enabled: false
        kubeEtcd.enabled: true
        kubeDns.enabled: false
      valuesFiles: 
        - "kube-prometheus-stack/values-custom.yaml"

    botkube:
      <<: *enabled
      description: "Botkube is a messaging bot for monitoring and debugging Kubernetes clusters"
      group: "monitoring"
      namespace: "observability"
      chart: "botkube"
      version: "v0.12.4"
      priority: -138
      set:
        config.settings.clustername: "$K8SCLUSTER"
        config.settings.kubectl.restrictAccess: true
        serviceMonitor.enabled: true
        communications.slack.enabled: true
        communications.slack.channel: "reports"
        communications.slack.token: "$BOTKUBE"

    grafana:
      <<: *enabled
      description: "Kubernetes Operator based on the Operator SDK for creating and managing Grafana instances and dashboards."
      group: "monitoring"
      namespace: "monitoring"
      chart: "grafana"
      version: "6.26.5"
      priority: -137
      set:
        ingress.enabled: true
        ingress.annotations.kubernetes\.io/ingress\.class: $K8S_INGRESS
        ingress.hosts[0]: grafana.$K8SCLUSTER.$K8S_CLUSTER
      valuesFiles:

    grafana-operator:
      <<: *enabled
      description: "Kubernetes Operator based on the Operator SDK for creating and managing Grafana instances and dashboards."
      group: "monitoring"
      namespace: "monitoring"
      chart: "grafana-operator"
      version: "4.2.0"
      priority: -136
      valuesFiles:

    grafana-operator-configs:
      <<: *enabled
      description: "Kubernetes Operator based on the Operator SDK for creating and managing Grafana instances and dashboards."
      group: "monitoring"
      namespace: "monitoring"
      chart: "grafana-operator-configs"
      version: "1.0.0"
      priority: -135
      valuesFiles:
        - "grafana-operator-configs/values.yaml"

    netdata:
      <<: *disabled
      description: "Netdata is a monitoring, visualization, and troubleshooting solution for systems, containers, services, and applications."
      group: "monitoring"
      namespace: "monitoring"
      chart: "netdata"
      version: "3.7.10"
      priority: -134
      set:
        ingress.enabled: true
        ingress.spec.ingressClassName: $K8S_INGRESS
        ingress.annotations.kubernetes\.io/ingress\.class: $K8S_INGRESS
        ingress.annotations.kubernetes\.io/tls-acme: "\"false\""
        ingress.hosts[0]: netdata.$K8SCLUSTER.$K8S_CLUSTER
        notifications.slackurl: SLACK_WEBHOOK_URL=$SLACK_HOOK
        notifications.slackrecipiet: "monitoring"
        parent.claiming.enabled: true
        parent.claiming.token: $NETDATA_TOKEN
        parent.claiming.rooms: $NETDATA_ROOMS
        parent.claiming.url: https://app.netdata.cloud
        child.claiming.enabled: true
        child.claiming.rooms: $NETDATA_ROOMS

  # Logging Block (priority: -130)

    loki:
      <<: *enabled
      description: "Loki: like Prometheus, but for logs."
      group: "logging"
      namespace: "monitoring"
      chart: "loki-stack"
      version: "2.6.5"
      priority: -129
      set:
        ingress.annotations.kubernetes\.io/ingress\.class: $K8S_INGRESS
        ingress.hosts\.host[0]: "loki.$K8SCLUSTER.$K8S_CLUSTER"
      valuesFiles: 

  # Security block (priority: -120)

  # Ingress Block (priority: -110)

    metallb:
      <<: *enabled
      description: "Load Balancer management for minikube"
      group: "ingress"
      namespace: "ingress"
      chart: "metallb"
      version: "0.12.1"
      priority: -110  # Increased due to minikube ip conflicts
      set:
        prometheusRule.enabled: true
        prometheusRUles.additionalLabels.release: "prometheus"
        ### Uncomment the line below for mesh support ###
        envoy.podAnnotations.linkerd\.io/inject: "ingress"
        ### Uncomment if runing on multi-cluster ###
        controller.nodeSelector.kubernetes\.io/hostname: "lima-glaedr-manager-1"
        controller.nodeSelector.ingress: "controller"
        # speaker.nodeSelector.node-role\.kubernetes\.io\/control\-plane: "true"
      valuesFiles:
        - "metallb/values.yaml"

    nginx:
      <<: *enabled
      description: "Nginx-Ingress Controller for K8S"
      group: "ingress"
      namespace: "ingress"
      chart: "ingress-nginx"
      version: "4.1.4"
      priority: -109
      set:
        controller.metrics.enabled: true
        controller.metrics.serviceMonitor.enabled: true
        controller.metrics.serviceMonitor.additionalLabels.release: "prometheus" 
        defaultBackend.enabled: false
        ### Uncomment the line below for mesh support ###
        controller.podAnnotations.linkerd\.io/inject: "ingress"
        ### Uncomment if runing on multi-node cluster ###
        controller.service.nodeSelector.kubernetes\.io/hostname: lima-glaedr-manager-1
        controller.nodeSelector.ingress: "controller"
        controller.watchIngressWithoutClass: true
        controller.tolerations[0].key: "ingress"
        controller.tolerations[0].effect: "NoSchedule"
        controller.tolerations[0].operator: "Exists"

    traefik:
      <<: *enabled
      description: "Edge Router that makes publishing your services a fun and easy experience"
      group: "ingress"
      namespace: "ingress"
      chart: "traefik"
      version: "10.19.4"
      priority: -108
      set:
        ports.traefik.expose: true
        additionalArguments[0]: "--metrics.prometheus=true"
        additionalArguments[1]: "--ping"
        additionalArguments[2]: "--log.format=json"
        additionalArguments[3]: "--accesslog=true"
        additionalArguments[4]: "--api.dashboard=true"
        deployment.podLabels.release: "prometheus"
        ingressClass.enabled: true
        ### Uncomment the line below for mesh support ###
        controller.podAnnotations.linkerd\.io/inject: "ingress"
        ### Uncomment if runing on multi-node cluster ###
        nodeSelector.kubernetes\.io/hostname: "lima-glaedr-manager-2"
        nodeSelector.ingress: "controller"
        tolerations[0].key: "ingress"
        tolerations[0].effect: "NoSchedule"
        tolerations[0].operator: "Exists"

    contour:
      <<: *disabled
      description: "High performance ingress controller for Kubernetes"
      group: "ingress"
      namespace: "ingress"
      chart: "contour"
      version: "7.8.0"
      priority: -107
      set:
        replicaCount: 1
        configInline.incluster: true
        default.backend.enabled: true
        envoy.serviceAccount.aumountServiceAccountToken: true
        prometheus.serviceMonitor.enabled: true
        ### Uncomment the line below for mesh support ###
        envoy.podAnnotations.linkerd\.io/inject: "ingress"
        ### Uncomment if runing on multi-cluster ###
        envoy.nodeSelector.kubernetes\.io\/hostname: "lima-glaedr-manager-3"
        envoy.nodeSelector.ingress: "controller"
        envoy.tolerations[0].key: "ingress"
        envoy.tolerations[0].effect: "NoSchedule"
        envoy.tolerations[0].operator: "Exists"

  # Observability & Tracing Block (priority: -90)

    opentelemetry:
      <<: *enabled
      description: "Use it to instrument, generate, collect, and export telemetry data (metrics, logs, and traces)"
      group: "observability"
      namespace: "observability"
      chart: "opentelemetry-operator"
      version: "0.8.2"
      priority: -90
      set:
        replicaCount: 3

  # Loft (priority: -80)

    loft:
      <<: *enabled
      description: "Namespace & Virtual Cluster Manager for Kubernetes"
      group: "clustering"
      namespace: "loft"
      chart: "loft"
      version: "2.1.8"
      priority: -80
      set:
        ingress.enabled: true
        ingress.host: loft.$K8SCLUSTER.$K8S_CLUSTER
        ingress.ingressClass: $K8S_INGRESS
        ingress.tls.enabled: false
        apiService.enabled: true
        labels.release: "prometheus"
        serviceMonitor.enabled: true
        serviceMonitor.labels.release: "prometheus"

    saphira-vcluster:
      <<: *disabled
      description: "Namespace & Virtual Cluster Manager for Kubernetes"
      group: "clustering"
      namespace: "loft"
      chart: "loft-vcluster"
      version: "0.8.1"
      priority: -78
      set:

  # Deployments & Automated Releases (priority: -60)

    flagger:
      <<: *enabled
      description: "A progressive delivery tool that automates the release process for applications running on Kubernetes."
      group: "releases"
      namespace: "miscellaneous" 
      chart: "flagger" 
      version: "1.20.0"
      priority: -60
      set:
        logLevel: "debug"
        meshProvider: "linkerd"
        ingressClass: $K8S_INGRESS
        slack.channel: "deploys"
        slack.url: "$SLACK_HOOK"
        podMonitor.enabled: true
        prometheus.install: false
        crd.create: false

    flagger-loadtester:
      <<: *enabled
      description: "Load testing services generates traffic during canary analysis when configured as a webhook."
      group: "releases"
      namespace: "miscellaneous" 
      chart: "flagger-loadtester" 
      version: "0.22.0"
      priority: -59
      set:
        logLevel: "debug"

  # Service Mesh Block (priority: -50) On minkube the limits from coreDNS must be removed in order to works!

    linkerd-certificates:
      <<: *enabled
      description: "Webhook certificates managed by cert-manager"
      group: "mesh"
      namespace: "linkerd"
      chart: "linkerd-certificates"
      version: "1.0.1"
      priority: -50

    linkerd:
      <<: *mesh1
      description: "Linkerd service mesh for K8S"
      group: "mesh"
      namespace: "linkerd"
      chart: "linkerd"
      version: "2.10.2"
      priority: -49

    linkerd-viz-certificates:
      <<: *disabled
      description: "Webhook certificates managed by cert-manager"
      group: "mesh"
      namespace: "linkerd-viz"
      chart: "linkerd-viz-certificates"
      version: "1.0.1"
      priority: -48

    linkerd-viz:
      <<: *mesh2
      description: "Linkerd Viz"
      group: "mesh"
      namespace: "linkerd-viz"
      chart: "linkerd-viz"
      version: "2.10.2"
      priority: -47

  # Third-party tools (priority: -40)

    loft-configs:
      <<: *enabled
      description: "Config, create, managed Spaces/vCluster/Isolations and so on."
      group: "miscellaneous"
      namespace: "loft"
      chart: "loft-config"
      version: "1.0.0"
      priority: -40
      set:
        spaces.enabled: true
        spaces.names[0]: "firnen"
        spaces.names[1]: "ophelia"
        vclusters.enabled: false

    helm-exporter:
      <<: *disabled
      description: "Exports helm release, chart, and version statistics in the prometheus format."
      group: "miscellaneous"
      namespace: "miscellaneous"
      chart: "helm-exporter"
      version: "1.2.2+6766a95"
      priority: -39
      set:
        ingress.enabled: false
        ingress.annotations.kubernetes\.io/ingress\.class: "$K8S_INGRESS"
        ingress.hosts[0].host: "helm-exporter.$K8SCLUSTER.$K8S_CLUSTER"
        ingress.hosts[0].paths[0]: "/"
        serviceMonitor.create: true
        serviceMonitor.additionalLabels.release: "prometheus"

    teleport-cluster:
      <<: *disabled
      description: "Loki: like Prometheus, but for logs."
      group: "miscellaneous"
      namespace: "security"
      chart: "teleport-cluster"
      version: "9.3.3"
      priority: -38
      set:
        clusterName: "$K8SCLUSTER"
        kubeClusterName: "$K8SCLUSTER"
